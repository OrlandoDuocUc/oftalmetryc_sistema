{% extends "base.html" %}

{% block title %}Gestión de Productos - Oftalmetryc{% endblock %}

{% block extra_css %}
/* ESTILOS ESPECÍFICOS DE PRODUCTOS */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.table th {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    font-weight: 600;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #2980b9, #1f618d);
    transform: translateY(-1px);
}
{% endblock %}

{% block content %}
<div class="container mt-5">
        <h1 class="text-center mb-4" style="font-family: 'Segoe UI', sans-serif; font-weight: bold; color: #2c3e50; letter-spacing: 2px;">Gestión de Productos</h1>
        
        <!-- Formulario para crear nuevo producto -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Crear Nuevo Producto</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombre del Producto</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="precio_unitario" class="form-label">Precio Unitario</label>
                            <input type="number" class="form-control" id="precio_unitario" name="precio_unitario" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="categoria" class="form-label">Categoría</label>
                            <input type="text" class="form-control" id="categoria" name="categoria" placeholder="Ej: Lentes, Marcos">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="marca" class="form-label">Marca</label>
                            <input type="text" class="form-control" id="marca" name="marca" placeholder="Ej: Ray-Ban">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="sku" class="form-label">SKU/Código</label>
                            <input type="text" class="form-control" id="sku" name="sku" placeholder="Ej: RB3025">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Producto</button>
                </form>
            </div>
        </div>

        <!-- Tabla de productos activos -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Productos Existentes</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Marca</th>
                            <th>SKU</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if products|length == 0 %}
                        <tr>
                            <td colspan="9" class="text-center">No hay productos activos registrados.</td>
                        </tr>
                        {% else %}
                        {% for p in products %}
                        <tr>
                            <td>{{ p.producto_id }}</td>
                            <td><strong>{{ p.nombre }}</strong></td>
                            <td>
                                <span class="badge bg-info">{{ p.categoria or 'Sin categoría' }}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ p.marca or 'Sin marca' }}</span>
                            </td>
                            <td>
                                <code>{{ p.sku or 'N/A' }}</code>
                            </td>
                            <td>
                                <small class="text-muted">{{ p.descripcion[:50] }}{% if p.descripcion|length > 50 %}...{% endif %}</small>
                            </td>
                            <td><strong>{{ p.precio_unitario|currency }}</strong></td>
                            <td>
                                <span class="badge {% if p.stock > 10 %}bg-success{% elif p.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ p.stock }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-info btn-sm" onclick="verDetalles({{ p.producto_id }})" title="Ver Detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="editarStock({{ p.producto_id }}, {{ p.stock }})" title="Editar Stock">
                                        <i class="fas fa-boxes"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarProducto"
                                        data-producto-id="{{ p.producto_id }}"
                                        data-nombre="{{ p.nombre }}"
                                        data-descripcion="{{ p.descripcion }}"
                                        data-precio="{{ p.precio_unitario }}"
                                        data-stock="{{ p.stock }}"
                                        data-categoria="{{ p.categoria or '' }}"
                                        data-marca="{{ p.marca or '' }}"
                                        data-sku="{{ p.sku or '' }}" title="Editar Producto">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminar" data-producto-id="{{ p.producto_id }}" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de productos eliminados (solo si se pasa deleted_products) -->
        {% if deleted_products is defined %}
        <div class="card mt-5">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Eliminados recientes</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-secondary">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in deleted_products %}
                        <tr>
                            <td>{{ p.producto_id }}</td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.descripcion }}</td>
                            <td>${{ p.precio_unitario }}</td>
                            <td>{{ p.stock }}</td>
                            <td>
                                <form method="post" action="/productos/restore/{{ p.producto_id }}" style="display:inline;">
                                    <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('¿Restaurar este producto?')">
                                        <i class="fa fa-undo"></i> Restaurar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <a href="/productos" class="btn btn-outline-primary mt-2"><i class="fa fa-arrow-left"></i> Volver a productos</a>
            </div>
        </div>
        {% endif %}

        <!-- Modales para editar y eliminar producto -->
        <!-- Modal Editar Producto -->
        <div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <form id="formEditarProducto" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="producto_id" id="editarProductoId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editarNombreProducto" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="editarNombreProducto" name="nombre" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editarPrecioProducto" class="form-label">Precio Unitario</label>
                                    <input type="number" class="form-control" id="editarPrecioProducto" name="precio_unitario" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editarCategoriaProducto" class="form-label">Categoría</label>
                                    <input type="text" class="form-control" id="editarCategoriaProducto" name="categoria" placeholder="Ej: Lentes, Marcos">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarMarcaProducto" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="editarMarcaProducto" name="marca" placeholder="Ej: Ray-Ban">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarSkuProducto" class="form-label">SKU/Código</label>
                                    <input type="text" class="form-control" id="editarSkuProducto" name="sku" placeholder="Ej: RB3025">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editarStockProducto" class="form-label">Stock</label>
                                    <input type="number" class="form-control" id="editarStockProducto" name="stock" min="0" required>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="editarDescripcionProducto" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="editarDescripcionProducto" name="descripcion" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal Eliminar Producto -->
        <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEliminarLabel">Confirmar eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        ¿Estás seguro de que quieres eliminar este producto?
                    </div>
                    <div class="modal-footer">
                        <form id="formEliminarProducto" method="post">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var modalEditarProducto = document.getElementById('modalEditarProducto');
        if (modalEditarProducto) {
            modalEditarProducto.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                var nombre = button.getAttribute('data-nombre');
                var descripcion = button.getAttribute('data-descripcion');
                var precio = button.getAttribute('data-precio');
                var stock = button.getAttribute('data-stock');
                var categoria = button.getAttribute('data-categoria');
                var marca = button.getAttribute('data-marca');
                var sku = button.getAttribute('data-sku');
                
                document.getElementById('editarProductoId').value = productoId;
                document.getElementById('editarNombreProducto').value = nombre;
                document.getElementById('editarDescripcionProducto').value = descripcion;
                document.getElementById('editarPrecioProducto').value = precio;
                document.getElementById('editarStockProducto').value = stock;
                document.getElementById('editarCategoriaProducto').value = categoria;
                document.getElementById('editarMarcaProducto').value = marca;
                document.getElementById('editarSkuProducto').value = sku;
                
                // Establecer action del formulario
                document.getElementById('formEditarProducto').action = '/productos/editar/' + productoId;
            });
        }

        var modalEliminar = document.getElementById('modalEliminar');
        if (modalEliminar) {
            modalEliminar.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                document.getElementById('formEliminarProducto').action = '/productos/eliminar/' + productoId;
            });
        }

        // Función para ver detalles del producto
        function verDetalles(productoId) {
            // Modal para mostrar detalles completos
            fetch(`/api/productos/${productoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const producto = data.producto;
                        Swal.fire({
                            title: `<strong>${producto.nombre}</strong>`,
                            html: `
                                <div class="text-start">
                                    <div class="row">
                                        <div class="col-6"><strong>ID:</strong> ${producto.producto_id}</div>
                                        <div class="col-6"><strong>SKU:</strong> ${producto.sku || 'N/A'}</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6"><strong>Categoría:</strong> ${producto.categoria || 'N/A'}</div>
                                        <div class="col-6"><strong>Marca:</strong> ${producto.marca || 'N/A'}</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6"><strong>Precio:</strong> $${producto.precio_unitario}</div>
                                        <div class="col-6"><strong>Stock:</strong> <span class="badge ${producto.stock > 10 ? 'bg-success' : producto.stock > 0 ? 'bg-warning' : 'bg-danger'}">${producto.stock}</span></div>
                                    </div>
                                    <div class="mt-3">
                                        <strong>Descripción:</strong><br>
                                        <p class="text-muted">${producto.descripcion || 'Sin descripción'}</p>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Creado: ${new Date(producto.fecha_creacion).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            `,
                            icon: 'info',
                            showCloseButton: true,
                            width: '500px'
                        });
                    } else {
                        Swal.fire('Error', 'No se pudo cargar la información del producto', 'error');
                    }
                })
                .catch(error => {
                    Swal.fire('Error', 'Error de conexión', 'error');
                });
        }

        // Función para editar stock
        function editarStock(productoId, stockActual) {
            Swal.fire({
                title: 'Editar Stock',
                input: 'number',
                inputLabel: 'Nuevo stock:',
                inputValue: stockActual,
                inputAttributes: {
                    min: 0,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || value < 0) {
                        return 'Por favor ingresa un stock válido'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar actualización de stock
                    const formData = new FormData();
                    formData.append('stock', result.value);
                    
                    fetch(`/productos/stock/${productoId}`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Actualizado!', 'Stock actualizado correctamente', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Error al actualizar stock', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error de conexión', 'error');
                    });
                }
            });
        }

        // Incluir SweetAlert2 para las notificaciones
        if (!document.querySelector('script[src*="sweetalert2"]')) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
            document.head.appendChild(script);
        }
                document.getElementById('formEditarProducto').action = '/productos/edit/' + productoId;
            });
        }
        var modalEliminar = document.getElementById('modalEliminar');
        if (modalEliminar) {
            modalEliminar.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                var form = document.getElementById('formEliminarProducto');
                form.action = '/productos/delete/' + productoId;
            });
        }
        function editarProducto(productoId) {
            var modal = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
            document.getElementById('editarProductoId').value = productoId;
            document.getElementById('formEditarProducto').action = '/productos/edit/' + productoId;
            modal.show();
        }
    </script>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Scripts específicos de productos si son necesarios
</script>
{% endblock %} 