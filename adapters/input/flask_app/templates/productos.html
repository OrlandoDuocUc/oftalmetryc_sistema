{% extends "base.html" %}

{% block title %}Gestión de Productos - Oftalmetryc{% endblock %}

{% block extra_css %}
/* ESTILOS ESPECÍFICOS DE PRODUCTOS */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.table th {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    font-weight: 600;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #2980b9, #1f618d);
    transform: translateY(-1px);
}
{% endblock %}

{% block content %}
<div class="container mt-5">
        <h1 class="text-center mb-4" style="font-family: 'Segoe UI', sans-serif; font-weight: bold; color: #2c3e50; letter-spacing: 2px;">Gestión de Productos</h1>
        
        <!-- Formulario para crear nuevo producto -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Crear Nuevo Producto</h5>
            </div>
            <div class="card-body">
                <form method="post" id="formCrearProducto">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="fecha" class="form-label">Fecha <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label for="nombre" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Ej: Armazón Metálico Classic" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="distribuidor" class="form-label">Distribuidor</label>
                            <input type="text" class="form-control" id="distribuidor" name="distribuidor" placeholder="Ej: Óptica Nacional S.A.">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="marca" class="form-label">Marca</label>
                            <input type="text" class="form-control" id="marca" name="marca" placeholder="Ej: Ray-Ban">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="material" class="form-label">Material</label>
                            <input type="text" class="form-control" id="material" name="material" placeholder="Ej: Acetato, Metal">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tipo_armazon" class="form-label">Tipo Armazón</label>
                            <input type="text" class="form-control" id="tipo_armazon" name="tipo_armazon" placeholder="Ej: Completo, Semi-al-aire">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="codigo" class="form-label">Código</label>
                            <input type="text" class="form-control" id="codigo" name="codigo" placeholder="Ej: RB3025">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="diametro_1" class="form-label">Diámetro 1</label>
                            <input type="text" class="form-control" id="diametro_1" name="diametro_1" placeholder="Ej: 52mm">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="diametro_2" class="form-label">Diámetro 2</label>
                            <input type="text" class="form-control" id="diametro_2" name="diametro_2" placeholder="Ej: 18mm">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="color" placeholder="Ej: Negro, Dorado">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cantidad" class="form-label">Cantidad <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cantidad" name="cantidad" min="0" value="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="costo_unitario" class="form-label">Costo Unitario <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="costo_unitario" name="costo_unitario" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-calculator me-2"></i>
                        <strong>Cálculos automáticos:</strong> Los siguientes valores se calcularán al guardar el producto:
                        <ul class="mb-0 mt-2">
                            <li><strong>Costo Total:</strong> Cantidad × Costo Unitario</li>
                            <li><strong>Precio Venta 1:</strong> Costo Unitario × 3</li>
                            <li><strong>Precio Venta 2:</strong> Costo Unitario × 2</li>
                        </ul>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="2" placeholder="Descripción adicional del producto"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Crear Producto</button>
                </form>
            </div>
        </div>

        <!-- Tabla de productos activos -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Productos Existentes</h5>
            </div>
            <div class="card-body">
                <!-- Buscador único -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="buscadorProductos" class="form-control" placeholder="Buscar por código, nombre, distribuidor o marca...">
                    </div>
                    <small class="text-muted">El buscador filtra en tiempo real por código, nombre, distribuidor y marca</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Nombre</th>
                                <th>Distribuidor</th>
                                <th>Marca</th>
                                <th>Código</th>
                                <th>Color</th>
                                <th>Cantidad</th>
                                <th>Costo Unit.</th>
                                <th>P. Venta 1</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if products|length == 0 %}
                            <tr>
                                <td colspan="11" class="text-center">No hay productos activos registrados.</td>
                            </tr>
                            {% else %}
                            {% for p in products %}
                            <tr>
                                <td>{{ p.producto_id }}</td>
                                <td><small>{{ p.fecha.strftime('%d/%m/%Y') if p.fecha else 'N/A' }}</small></td>
                                <td><strong>{{ p.nombre }}</strong></td>
                                <td><small>{{ p.distribuidor or '-' }}</small></td>
                                <td><span class="badge bg-secondary">{{ p.marca or '-' }}</span></td>
                                <td><code>{{ p.codigo or '-' }}</code></td>
                                <td>{{ p.color or '-' }}</td>
                                <td>
                                    <span class="badge {% if p.cantidad > 10 %}bg-success{% elif p.cantidad > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ p.cantidad }}
                                    </span>
                                </td>
                                <td>{{ p.costo_unitario|currency }}</td>
                                <td><strong>{{ p.costo_venta_1|currency if p.costo_venta_1 else '-' }}</strong></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-info btn-sm" onclick="verDetalles({{ p.producto_id }})" title="Ver Detalles">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarProducto"
                                            data-producto-id="{{ p.producto_id }}"
                                            data-fecha="{{ p.fecha.strftime('%Y-%m-%d') if p.fecha else '' }}"
                                            data-nombre="{{ p.nombre }}"
                                            data-distribuidor="{{ p.distribuidor or '' }}"
                                            data-marca="{{ p.marca or '' }}"
                                            data-material="{{ p.material or '' }}"
                                            data-tipo-armazon="{{ p.tipo_armazon or '' }}"
                                            data-codigo="{{ p.codigo or '' }}"
                                            data-diametro1="{{ p.diametro_1 or '' }}"
                                            data-diametro2="{{ p.diametro_2 or '' }}"
                                            data-color="{{ p.color or '' }}"
                                            data-cantidad="{{ p.cantidad }}"
                                            data-costo-unitario="{{ p.costo_unitario }}"
                                            data-costo-total="{{ p.costo_total or '' }}"
                                            data-costo-venta1="{{ p.costo_venta_1 or '' }}"
                                            data-costo-venta2="{{ p.costo_venta_2 or '' }}"
                                            data-descripcion="{{ p.descripcion or '' }}" 
                                            title="Editar Producto">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminar" data-producto-id="{{ p.producto_id }}" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tabla de productos eliminados (solo si se pasa deleted_products) -->
        {% if deleted_products is defined %}
        <div class="card mt-5">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Eliminados recientes</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead class="table-secondary">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in deleted_products %}
                        <tr>
                            <td>{{ p.producto_id }}</td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.descripcion }}</td>
                            <td>${{ p.precio_unitario }}</td>
                            <td>{{ p.stock }}</td>
                            <td>
                                <form method="post" action="/productos/restore/{{ p.producto_id }}" style="display:inline;">
                                    <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('¿Restaurar este producto?')">
                                        <i class="fa fa-undo"></i> Restaurar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <a href="/productos" class="btn btn-outline-primary mt-2"><i class="fa fa-arrow-left"></i> Volver a productos</a>
            </div>
        </div>
        {% endif %}

        <!-- Modales para editar y eliminar producto -->
        <!-- Modal Editar Producto -->
        <div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <form id="formEditarProducto" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="producto_id" id="editarProductoId">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editarFecha" class="form-label">Fecha <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="editarFecha" name="fecha" required>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="editarNombreProducto" class="form-label">Nombre <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editarNombreProducto" name="nombre" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editarDistribuidor" class="form-label">Distribuidor</label>
                                    <input type="text" class="form-control" id="editarDistribuidor" name="distribuidor">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editarMarcaProducto" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="editarMarcaProducto" name="marca">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editarMaterial" class="form-label">Material</label>
                                    <input type="text" class="form-control" id="editarMaterial" name="material">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarTipoArmazon" class="form-label">Tipo Armazón</label>
                                    <input type="text" class="form-control" id="editarTipoArmazon" name="tipo_armazon">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarCodigo" class="form-label">Código</label>
                                    <input type="text" class="form-control" id="editarCodigo" name="codigo">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editarDiametro1" class="form-label">Diámetro 1</label>
                                    <input type="text" class="form-control" id="editarDiametro1" name="diametro_1">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarDiametro2" class="form-label">Diámetro 2</label>
                                    <input type="text" class="form-control" id="editarDiametro2" name="diametro_2">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editarColor" class="form-label">Color</label>
                                    <input type="text" class="form-control" id="editarColor" name="color">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editarCantidad" class="form-label">Cantidad <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="editarCantidad" name="cantidad" min="0" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editarCostoUnitario" class="form-label">Costo Unitario <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="editarCostoUnitario" name="costo_unitario" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-calculator me-2"></i>
                                <small><strong>Al guardar se recalcularán automáticamente:</strong> Costo Total, Precio Venta 1 y Precio Venta 2.</small>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="editarDescripcionProducto" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="editarDescripcionProducto" name="descripcion" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal Eliminar Producto -->
        <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEliminarLabel">Confirmar eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        ¿Estás seguro de que quieres eliminar este producto?
                    </div>
                    <div class="modal-footer">
                        <form id="formEliminarProducto" method="post">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Éxito -->
        <div class="modal fade" id="modalExito" tabindex="-1" aria-labelledby="modalExitoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="modalExitoLabel">
                            <i class="fas fa-check-circle me-2"></i>¡Éxito!
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Producto Creado Exitosamente</h4>
                        <p class="text-muted">El producto ha sido registrado correctamente en el inventario.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Establecer fecha actual por defecto y verificar si se creó un producto
        document.addEventListener('DOMContentLoaded', function() {
            const fechaInput = document.getElementById('fecha');
            if (fechaInput && !fechaInput.value) {
                const today = new Date().toISOString().split('T')[0];
                fechaInput.value = today;
            }

            // Verificar si se creó un producto exitosamente (detectar query parameter)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('created') === 'true') {
                const modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
                modalExito.show();
                
                // Limpiar el parámetro de la URL sin recargar la página
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        });

        // Todos los cálculos (costo_total, costo_venta_1, costo_venta_2) 
        // se realizan automáticamente en el backend al guardar

        var modalEditarProducto = document.getElementById('modalEditarProducto');
        if (modalEditarProducto) {
            modalEditarProducto.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                var fecha = button.getAttribute('data-fecha');
                var nombre = button.getAttribute('data-nombre');
                var distribuidor = button.getAttribute('data-distribuidor');
                var marca = button.getAttribute('data-marca');
                var material = button.getAttribute('data-material');
                var tipoArmazon = button.getAttribute('data-tipo-armazon');
                var codigo = button.getAttribute('data-codigo');
                var diametro1 = button.getAttribute('data-diametro1');
                var diametro2 = button.getAttribute('data-diametro2');
                var color = button.getAttribute('data-color');
                var cantidad = button.getAttribute('data-cantidad');
                var costoUnitario = button.getAttribute('data-costo-unitario');
                var descripcion = button.getAttribute('data-descripcion');
                
                document.getElementById('editarProductoId').value = productoId;
                document.getElementById('editarFecha').value = fecha;
                document.getElementById('editarNombreProducto').value = nombre;
                document.getElementById('editarDistribuidor').value = distribuidor;
                document.getElementById('editarMarcaProducto').value = marca;
                document.getElementById('editarMaterial').value = material;
                document.getElementById('editarTipoArmazon').value = tipoArmazon;
                document.getElementById('editarCodigo').value = codigo;
                document.getElementById('editarDiametro1').value = diametro1;
                document.getElementById('editarDiametro2').value = diametro2;
                document.getElementById('editarColor').value = color;
                document.getElementById('editarCantidad').value = cantidad;
                document.getElementById('editarCostoUnitario').value = costoUnitario;
                document.getElementById('editarDescripcionProducto').value = descripcion;
                
                // Establecer action del formulario
                document.getElementById('formEditarProducto').action = '/productos/editar/' + productoId;
            });
        }

        var modalEliminar = document.getElementById('modalEliminar');
        if (modalEliminar) {
            modalEliminar.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                document.getElementById('formEliminarProducto').action = '/productos/eliminar/' + productoId;
            });
        }

        // Función para ver detalles del producto
        function verDetalles(productoId) {
            // Modal para mostrar detalles completos
            fetch(`/api/productos/${productoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const producto = data.producto;
                        Swal.fire({
                            title: `<strong>${producto.nombre}</strong>`,
                            html: `
                                <div class="text-start">
                                    <div class="row">
                                        <div class="col-6"><strong>ID:</strong> ${producto.producto_id}</div>
                                        <div class="col-6"><strong>SKU:</strong> ${producto.sku || 'N/A'}</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6"><strong>Categoría:</strong> ${producto.categoria || 'N/A'}</div>
                                        <div class="col-6"><strong>Marca:</strong> ${producto.marca || 'N/A'}</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6"><strong>Precio:</strong> $${producto.precio_unitario}</div>
                                        <div class="col-6"><strong>Stock:</strong> <span class="badge ${producto.stock > 10 ? 'bg-success' : producto.stock > 0 ? 'bg-warning' : 'bg-danger'}">${producto.stock}</span></div>
                                    </div>
                                    <div class="mt-3">
                                        <strong>Descripción:</strong><br>
                                        <p class="text-muted">${producto.descripcion || 'Sin descripción'}</p>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Creado: ${new Date(producto.fecha_creacion).toLocaleDateString()}</small>
                                    </div>
                                </div>
                            `,
                            icon: 'info',
                            showCloseButton: true,
                            width: '500px'
                        });
                    } else {
                        Swal.fire('Error', 'No se pudo cargar la información del producto', 'error');
                    }
                })
                .catch(error => {
                    Swal.fire('Error', 'Error de conexión', 'error');
                });
        }

        // Función para editar stock
        function editarStock(productoId, stockActual) {
            Swal.fire({
                title: 'Editar Stock',
                input: 'number',
                inputLabel: 'Nuevo stock:',
                inputValue: stockActual,
                inputAttributes: {
                    min: 0,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value || value < 0) {
                        return 'Por favor ingresa un stock válido'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar actualización de stock
                    const formData = new FormData();
                    formData.append('stock', result.value);
                    
                    fetch(`/productos/stock/${productoId}`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Actualizado!', 'Stock actualizado correctamente', 'success')
                                .then(() => location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Error al actualizar stock', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Error de conexión', 'error');
                    });
                }
            });
        }

        // Incluir SweetAlert2 para las notificaciones
        if (!document.querySelector('script[src*="sweetalert2"]')) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
            document.head.appendChild(script);
        }

        // BUSCADOR ÚNICO - Filtra productos en tiempo real
        const buscadorInput = document.getElementById('buscadorProductos');
        if (buscadorInput) {
            buscadorInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const tableRows = document.querySelectorAll('tbody tr');
                
                tableRows.forEach(row => {
                    // Obtener texto de las columnas relevantes: nombre, distribuidor, marca, código
                    const nombre = row.cells[2]?.textContent.toLowerCase() || '';
                    const distribuidor = row.cells[3]?.textContent.toLowerCase() || '';
                    const marca = row.cells[4]?.textContent.toLowerCase() || '';
                    const codigo = row.cells[5]?.textContent.toLowerCase() || '';
                    
                    // Buscar coincidencias en cualquiera de estos campos
                    const matches = nombre.includes(searchTerm) || 
                                   distribuidor.includes(searchTerm) || 
                                   marca.includes(searchTerm) || 
                                   codigo.includes(searchTerm);
                    
                    // Mostrar u ocultar la fila según coincidencias
                    row.style.display = matches ? '' : 'none';
                });
            });
        }
                document.getElementById('formEditarProducto').action = '/productos/edit/' + productoId;
            });
        }
        var modalEliminar = document.getElementById('modalEliminar');
        if (modalEliminar) {
            modalEliminar.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var productoId = button.getAttribute('data-producto-id');
                var form = document.getElementById('formEliminarProducto');
                form.action = '/productos/delete/' + productoId;
            });
        }
        function editarProducto(productoId) {
            var modal = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
            document.getElementById('editarProductoId').value = productoId;
            document.getElementById('formEditarProducto').action = '/productos/edit/' + productoId;
            modal.show();
        }
        // Manejo del formulario de creación con modal de éxito
        document.getElementById('formCrearProducto').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/productos', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // Si hay redirección, mostrar modal de éxito
                    Swal.fire({
                        title: '¡Éxito!',
                        text: 'Producto creado exitosamente',
                        icon: 'success',
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#3498db'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = response.url;
                        }
                    });
                } else {
                    return response.text();
                }
            })
            .then(html => {
                if (html) {
                    // Si hay HTML de respuesta, verificar si hay errores
                    if (html.includes('Error') || html.includes('error')) {
                        Swal.fire({
                            title: 'Error',
                            text: 'Hubo un error al crear el producto. Verifica los campos.',
                            icon: 'error',
                            confirmButtonText: 'Aceptar'
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error de conexión al crear el producto',
                    icon: 'error',
                    confirmButtonText: 'Aceptar'
                });
            });
        });
    </script>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Scripts específicos de productos si son necesarios
</script>
{% endblock %} 