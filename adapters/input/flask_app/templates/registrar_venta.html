{% extends "base.html" %}

{% block title %}Registrar Venta - Oftalmetryc{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Registrar Nueva Venta</h2>
    </div>

    <!-- Formulario principal que engloba todo el pedido -->
    <form action="{{ url_for('sale_html.revisar_venta_page') }}" method="POST" id="sale-form">
        <!-- Campo oculto para enviar los datos del pedido en formato JSON -->
        <input type="hidden" name="pedido_items" id="pedido_items_json">

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Detalle del Pedido</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Producto</th>
                                <th style="width: 15%;" class="text-center">Cantidad</th>
                                <th style="width: 20%;" class="text-end">Precio Unit.</th>
                                <th style="width: 20%;" class="text-end">Subtotal</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pedido-items-container">
                            <!-- Las filas de productos se agregarán aquí con JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="table-light fw-bold">
                                <td colspan="3" class="text-end fs-5">Total General:</td>
                                <td class="text-end fs-5" id="total-general">0 CLP</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <button type="button" id="btn-add-product" class="btn btn-success" onclick="agregarFilaProducto()">
                    <i class="fas fa-plus me-2"></i>Agregar Producto
                </button>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <!-- BOTÓN "CANCELAR" ACTUALIZADO -->
            <a href="{{ url_for('product_html.dashboard') }}" class="btn btn-secondary" id="dashboard-link">Dashboard</a>
            <button type="submit" class="btn btn-primary btn-lg">Confirmar Venta <i class="fas fa-arrow-right ms-2"></i></button>
        </div>
    </form>
</div>

<!-- Plantilla para una nueva fila de producto (oculta) -->
<template id="fila-producto-template">
    <tr>
        <td>
            <input class="form-control producto-select" placeholder="Escribe para buscar un producto...">
        </td>
        <td>
            <input type="number" class="form-control cantidad-input text-center" value="1" min="1" onchange="actualizarFila(this)" onkeyup="actualizarFila(this)">
        </td>
        <td class="text-end precio-unit-cell">0 CLP</td>
        <td class="text-end subtotal-cell">0 CLP</td>
        <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

<!-- ===== INICIO DE MODALES PARA NOTIFICACIONES (REEMPLAZA A LOS ALERT) ===== -->
<!-- Modal para Confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirmar Acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                ¿Estás seguro?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>
<!-- ===== FIN DE MODALES ===== -->

{% endblock %}

{% block extra_js %}
<script>
    const productosData = JSON.parse('{{ products_json|safe }}');
    const productosOptions = productosData.map(p => ({
        value: p.producto_id.toString(),
        text: p.nombre
    }));

    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('pedido-items-container').children.length === 0) {
            agregarFilaProducto();
        }
        
        // --- INICIO CORRECCIÓN: Lógica de confirmación para salir ---
        document.getElementById('dashboard-link').addEventListener('click', function(event) {
            const pedidoJson = document.getElementById('pedido_items_json').value;
            // Verificar si el pedido no está vacío
            if (pedidoJson && pedidoJson !== '[]' && pedidoJson !== '') {
                event.preventDefault(); // Detener la navegación del enlace
                showConfirm(
                    'Venta en Curso',
                    'Tienes productos en el pedido. ¿Estás seguro de que quieres salir y descartar la venta actual?',
                    () => {
                        // Esta función se ejecuta solo si el usuario presiona "Confirmar"
                        window.location.href = this.href; // Continuar a la URL del dashboard
                    }
                );
            }
        });
        // --- FIN CORRECCIÓN ---
    });
    
    function agregarFilaProducto() {
        const container = document.getElementById('pedido-items-container');
        const lastRow = container.lastElementChild;

        if (lastRow) {
            const lastSelect = lastRow.querySelector('.producto-select');
            if (!lastSelect.tomselect || !lastSelect.tomselect.getValue()) {
                return; 
            }
        }
        
        const template = document.getElementById('fila-producto-template');
        const newRow = template.content.cloneNode(true);
        container.appendChild(newRow);
        
        const selectInput = container.lastElementChild.querySelector('.producto-select');
        
        new TomSelect(selectInput, {
            dropdownParent: 'body',
            maxItems: 1,
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            },
            options: productosOptions,
            onChange: function(value) {
                actualizarFila(this.wrapper);
                if (value) {
                    this.blur();
                }
            }
        });
    }

    function eliminarFila(button) {
        const container = document.getElementById('pedido-items-container');
        const row = button.closest('tr');
        
        if (container.children.length > 1) {
            const select = row.querySelector('.producto-select');
            if (select && select.tomselect) {
                select.tomselect.destroy();
            }
            row.remove();
        } else {
            const select = row.querySelector('.producto-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            
            if (select && select.tomselect) {
                select.tomselect.clear();
            }
            cantidadInput.value = 1;
            actualizarFila(row);
        }
        
        calcularTotalGeneral();
    }

    // El resto de tu JavaScript (actualizarFila, calcularTotalGeneral, etc.)
    // no necesita cambios y funciona correctamente.
    function actualizarFila(element) {
        const row = element.closest('tr');
        const selectInput = row.querySelector('.producto-select');
        const cantidadInput = row.querySelector('.cantidad-input');
        const precioCell = row.querySelector('.precio-unit-cell');
        const subtotalCell = row.querySelector('.subtotal-cell');

        const productoId = selectInput.tomselect ? selectInput.tomselect.getValue() : null;
        const producto = productosData.find(p => p.producto_id.toString() === productoId);
        
        if (producto) {
            const cantidad = parseInt(cantidadInput.value) || 0;
            const precio = parseFloat(producto.precio_unitario);
            const subtotal = cantidad * precio;

            precioCell.textContent = precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
            subtotalCell.textContent = subtotal.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
        } else {
            precioCell.textContent = '0 CLP';
            subtotalCell.textContent = '0 CLP';
        }
        calcularTotalGeneral();
    }

    function calcularTotalGeneral() {
        const container = document.getElementById('pedido-items-container');
        const rows = container.querySelectorAll('tr');
        let totalGeneral = 0;

        rows.forEach(row => {
            const subtotalCell = row.querySelector('.subtotal-cell');
            const subtotalValue = parseFloat(subtotalCell.textContent.replace(/[$.CLP\s]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            totalGeneral += subtotalValue;
        });
        
        document.getElementById('total-general').textContent = totalGeneral.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
        actualizarPedidoJson();
    }
    
    function actualizarPedidoJson() {
        const container = document.getElementById('pedido-items-container');
        const rows = container.querySelectorAll('tr');
        const pedidoItems = [];

        rows.forEach(row => {
            const selectInput = row.querySelector('.producto-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const productoId = selectInput.tomselect ? selectInput.tomselect.getValue() : null;
            const producto = productosData.find(p => p.producto_id.toString() === productoId);

            if (producto) {
                const cantidad = parseInt(cantidadInput.value);
                if (cantidad > 0) {
                    pedidoItems.push({
                        producto_id: producto.producto_id,
                        nombre: producto.nombre,
                        cantidad: cantidad,
                        precio_unitario: parseFloat(producto.precio_unitario),
                        subtotal: cantidad * parseFloat(producto.precio_unitario)
                    });
                }
            }
        });

        document.getElementById('pedido_items_json').value = JSON.stringify(pedidoItems);
    }
    
    function showConfirm(title, message, callback) {
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;
        
        const confirmButton = document.getElementById('confirmModalButton');
        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);

        newConfirmButton.addEventListener('click', () => {
            callback();
            confirmModal.hide();
        }, { once: true }); // Asegura que el evento se dispare solo una vez

        confirmModal.show();
    }
</script>
{% endblock %}

